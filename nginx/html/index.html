<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Game Hub - Login</title>
    <link rel="stylesheet" href="/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="icon" href="https://cdn.simpleicons.org/github/ffffff" type="image/svg+xml">
    <style>
        /* [ì¶”ê°€] ëª¨ë‹¬(ë¡œê·¸ì¸ ì°½) ìŠ¤íƒ€ì¼ */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: var(--box-bg); padding: 24px; border-radius: 8px; width: 320px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 1px solid var(--border-color);
        }
        .modal h2 { margin-top: 0; color: var(--text-primary); }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 14px; }
        .form-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 24px; }
        .tab-group { display: flex; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .tab {
            flex: 1; padding: 10px; text-align: center; cursor: pointer; color: var(--text-secondary);
            border-bottom: 2px solid transparent; font-weight: 500;
        }
        .tab.active { color: var(--link-color); border-bottom-color: var(--link-color); }
        .user-info { display: flex; align-items: center; gap: 12px; font-size: 14px; }
    </style>
</head>
<body>

<header>
    <div class="repo-breadcrumb">
        <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" width="30" style="border-radius:50%; opacity:1;">
        <a href="#" class="repo-name">game-hub</a>
        <span class="badge">Public</span>
    </div>

    <div style="display: flex; gap: 8px; align-items: center;">
        <div id="loggedOutArea">
            <button class="btn-go" onclick="openModal()">Sign in</button>
        </div>
        <div id="loggedInArea" class="hidden user-info">
            <span style="color: var(--text-primary);">ğŸ‘‹ <b id="userNickname">User</b></span>
            <button class="btn-go" onclick="logout()">Sign out</button>
        </div>

        <button class="theme-btn" onclick="toggleTheme()" id="themeBtn">
            <i class="fas fa-moon"></i> Dark
        </button>
    </div>
</header>

<div class="container">
    <div class="box">
        <div class="box-header">
            <div style="display:flex; align-items:center; gap: 8px;">
                <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" width="20" style="border-radius:50%; opacity:0.7;">
                <span style="font-weight:600;">System</span>
                <span class="last-commit" id="lastCheckTime">Latest check: just now</span>
            </div>
        </div>

        <table>
            <tbody>
            <tr>
                <td class="icon-col"><i class="fas fa-folder" style="color: #54aeff;"></i></td>
                <td class="name-col"><a href="/catchmind/" class="name-link" id="link-catchmind">catchmind</a></td>
                <td class="desc-col">ì‹¤ì‹œê°„ ê·¸ë¦¼ í€´ì¦ˆ ê²Œì„ ì„œë¹„ìŠ¤</td>
                <td class="status-col">
                    <span id="dot-catchmind" class="status-dot checking"></span>
                    <span id="text-catchmind" style="font-size:12px; color:var(--text-secondary);">Checking</span>
                </td>
                <td style="width: 60px; text-align: center;">
                    <a href="/catchmind/" id="btn-catchmind" class="btn-go disabled">Go</a>
                </td>
            </tr>
            <tr>
                <td class="icon-col"><i class="fas fa-folder" style="color: #54aeff;"></i></td>
                <td class="name-col"><a href="/KKUTU/" class="name-link" id="link-KKUTU">KKUTU</a></td>
                <td class="desc-col">ì‹¤ì‹œê°„ ëë§ì‡ê¸° ëŒ€ê²° ì„œë¹„ìŠ¤</td>
                <td class="status-col">
                    <span id="dot-KKUTU" class="status-dot checking"></span>
                    <span id="text-KKUTU" style="font-size:12px; color:var(--text-secondary);">Checking</span>
                </td>
                <td style="width: 60px; text-align: center;">
                    <a href="/KKUTU/" id="btn-KKUTU" class="btn-go disabled">Go</a>
                </td>
            </tr>
            <tr>
                <td class="icon-col"><i class="fas fa-folder" style="color: #54aeff;"></i></td>
                <td class="name-col"><a href="/Oh_Mock/" class="name-link" id="link-Oh_Mock">Oh!_Mock</a></td>
                <td class="desc-col">1 ëŒ€ 1 ì´ë¯¸ì§€ ì˜¤ëª© ì„œë¹„ìŠ¤</td>
                <td class="status-col">
                    <span id="dot-Oh_Mock" class="status-dot checking"></span>
                    <span id="text-Oh_Mock" style="font-size:12px; color:var(--text-secondary);">Checking</span>
                </td>
                <td style="width: 60px; text-align: center;">
                    <a href="/Oh_Mock/" id="btn-Oh_Mock" class="btn-go disabled">Go</a>
                </td>
            </tr>
            <tr>
                <td class="icon-col"><i class="fas fa-folder" style="color: #54aeff;"></i></td>
                <td class="name-col"><a href="/Yacht_Dice/" class="name-link" id="link-Yacht_Dice">Yacht_Dice</a></td>
                <td class="desc-col">ì•¼ì¶” ë‹¤ì´ìŠ¤</td>
                <td class="status-col">
                    <span id="dot-Yacht_Dice" class="status-dot checking"></span>
                    <span id="text-Yacht_Dice" style="font-size:12px; color:var(--text-secondary);">Checking</span>
                </td>
                <td style="width: 60px; text-align: center;">
                    <a href="/Yacht_Dice/" id="btn-Yacht_Dice" class="btn-go disabled">Go</a>
                </td>
            </tr>
            <tr>
                <td class="icon-col"><i class="fas fa-folder" style="color: #54aeff;"></i></td>
                <td class="name-col"><a href="/indian_poker/" class="name-link" id="link-indian_poker">indian_poker</a></td>
                <td class="desc-col">ì¸ë””ì–¸ í¬ì»¤</td>
                <td class="status-col">
                    <span id="dot-indian_poker" class="status-dot checking"></span>
                    <span id="text-indian_poker" style="font-size:12px; color:var(--text-secondary);">Checking</span>
                </td>
                <td style="width: 60px; text-align: center;">
                    <a href="/indian_poker/" id="btn-indian_poker" class="btn-go disabled">Go</a>
                </td>
            </tr>
            <tr>
                <td class="icon-col"><i class="fas fa-folder" style="color: #54aeff;"></i></td>
                <td class="name-col"><a href="/mahe/" class="name-link" id="link-mahe">mahe</a></td>
                <td class="desc-col">ë§ˆí—¤</td>
                <td class="status-col">
                    <span id="dot-mahe" class="status-dot checking"></span>
                    <span id="text-mahe" style="font-size:12px; color:var(--text-secondary);">Checking</span>
                </td>
                <td style="width: 60px; text-align: center;">
                    <a href="/mahe/" id="btn-mahe" class="btn-go disabled">Go</a>
                </td>
            </tr>
            <tr>
                <td class="icon-col"><i class="fas fa-folder" style="color: #54aeff;"></i></td>
                <td class="name-col"><a href="/UNO/" class="name-link" id="link-UNO">UNO!</a></td>
                <td class="desc-col">ìš°ë…¸!</td>
                <td class="status-col">
                    <span id="dot-UNO" class="status-dot checking"></span>
                    <span id="text-UNO" style="font-size:12px; color:var(--text-secondary);">Checking</span>
                </td>
                <td style="width: 60px; text-align: center;">
                    <a href="/UNO/" id="btn-UNO" class="btn-go disabled">Go</a>
                </td>
            </tr>
            <tr>
                <td class="icon-col"><i class="fas fa-folder" style="color: #54aeff;"></i></td>
                <td class="name-col"><a href="/Clue/" class="name-link" id="link-Clue">Clue</a></td>
                <td class="desc-col">í´ë£¨</td>
                <td class="status-col">
                    <span id="dot-Clue" class="status-dot checking"></span>
                    <span id="text-Clue" style="font-size:12px; color:var(--text-secondary);">Checking</span>
                </td>
                <td style="width: 60px; text-align: center;">
                    <a href="/Clue/" id="btn-Clue" class="btn-go disabled">Go</a>
                </td>
            </tr>
            <tr>
                <td class="icon-col"><i class="far fa-file-alt"></i></td>
                <td class="name-col">README.md</td>
                <td class="desc-col">ê²Œì„ ì„œë²„ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œì…ë‹ˆë‹¤.</td>
                <td class="status-col"></td>
                <td></td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<div id="authModal" class="modal">
    <div class="modal-content">
        <div class="tab-group">
            <div class="tab active" onclick="switchTab('login')">Login</div>
            <div class="tab" onclick="switchTab('signup')">Sign up</div>
        </div>

        <div id="loginForm">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="loginId" placeholder="ì•„ì´ë”” ì…ë ¥">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
            </div>
            <div class="form-actions">
                <button class="btn-go" onclick="closeModal()">Cancel</button>
                <button class="btn-primary" onclick="reqLogin()">Sign in</button>
            </div>
        </div>

        <div id="signupForm" class="hidden">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="signId" placeholder="ì‚¬ìš©í•  ì•„ì´ë””">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="signPw" placeholder="ë¹„ë°€ë²ˆí˜¸">
            </div>
            <div class="form-group">
                <label>Nickname</label>
                <input type="text" id="signNick" placeholder="ê²Œì„ ë‹‰ë„¤ì„">
            </div>
            <div class="form-actions">
                <button class="btn-go" onclick="closeModal()">Cancel</button>
                <button class="btn-primary" onclick="reqSignup()">Create Account</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- [1] í…Œë§ˆ ì„¤ì • ---
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        document.getElementById('themeBtn').innerHTML = isDark ? '<i class="fas fa-sun"></i> Light' : '<i class="fas fa-moon"></i> Dark';
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }
    if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-mode');
        document.getElementById('themeBtn').innerHTML = '<i class="fas fa-sun"></i> Light';
    }

    // --- [2] ë¡œê·¸ì¸/íšŒì›ê°€ì… ë¡œì§ ---
    const AUTH_API = '/auth'; // nginx ë¼ìš°íŒ… ê²½ë¡œ

    // ì´ˆê¸° ë¡œë“œì‹œ í† í° ì²´í¬
    window.onload = function() {
        const token = localStorage.getItem('accessToken');
        const nick = localStorage.getItem('nickname');
        if(token && nick) {
            setLoggedInUI(nick);
        }
        runChecks(); setInterval(runChecks, 3000); // ì„œë²„ ìƒíƒœ ì²´í¬ ì‹œì‘
    }

    function setLoggedInUI(nickname) {
        document.getElementById('loggedOutArea').classList.add('hidden');
        document.getElementById('loggedInArea').classList.remove('hidden');
        document.getElementById('userNickname').innerText = nickname;
    }

    function setLoggedOutUI() {
        document.getElementById('loggedOutArea').classList.remove('hidden');
        document.getElementById('loggedInArea').classList.add('hidden');
        localStorage.removeItem('accessToken');
        localStorage.removeItem('nickname');
    }

    function logout() {
        setLoggedOutUI();
        alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // ëª¨ë‹¬ ê´€ë ¨
    function openModal() { document.getElementById('authModal').classList.add('active'); }
    function closeModal() { document.getElementById('authModal').classList.remove('active'); }
    function switchTab(mode) {
        const tabs = document.querySelectorAll('.tab');
        if(mode === 'login') {
            tabs[0].classList.add('active'); tabs[1].classList.remove('active');
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('signupForm').classList.add('hidden');
        } else {
            tabs[0].classList.remove('active'); tabs[1].classList.add('active');
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
        }
    }

    // API í˜¸ì¶œ
    async function reqLogin() {
        const id = document.getElementById('loginId').value;
        const pw = document.getElementById('loginPw').value;
        if(!id || !pw) return alert('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

        try {
            const res = await fetch(`${AUTH_API}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: id, password: pw })
            });
            const data = await res.json();

            if(res.ok) {
                localStorage.setItem('accessToken', data.token);
                localStorage.setItem('nickname', data.nickname);
                localStorage.setItem('username', id);
                setLoggedInUI(data.nickname);
                closeModal();
                alert('ë¡œê·¸ì¸ ì„±ê³µ!');
            } else {
                alert(data.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
            }
        } catch(e) { console.error(e); alert('ì„œë²„ ì˜¤ë¥˜ ë°œìƒ'); }
    }

    async function reqSignup() {
        const id = document.getElementById('signId').value;
        const pw = document.getElementById('signPw').value;
        const nick = document.getElementById('signNick').value;
        if(!id || !pw || !nick) return alert('ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

        try {
            const res = await fetch(`${AUTH_API}/signup`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: id, password: pw, nickname: nick })
            });

            if(res.ok) {
                alert('íšŒì›ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
                switchTab('login');
            } else {
                const text = await res.text();
                alert(text || 'íšŒì›ê°€ì… ì‹¤íŒ¨');
            }
        } catch(e) { console.error(e); alert('ì„œë²„ ì˜¤ë¥˜ ë°œìƒ'); }
    }

    // --- [3] ì„œë²„ ìƒíƒœ ì²´í¬ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€) ---
    async function checkStatus(gameId, url) {
        const dot = document.getElementById(`dot-${gameId}`);
        const text = document.getElementById(`text-${gameId}`);
        const btn = document.getElementById(`btn-${gameId}`);
        // ë¡œê·¸ì¸ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ì„œë²„ ìƒíƒœëŠ” ì²´í¬í•˜ë˜, ì‹¤ì œ ê²Œì„ ì…ì¥ ì‹œ í† í° ì²˜ë¦¬ëŠ” ê²Œì„ ë‚´ë¶€ì—ì„œ í•¨
        try {
            const controller = new AbortController();
            setTimeout(() => controller.abort(), 1000);
            const response = await fetch(url, { method: 'HEAD', signal: controller.signal });
            if (response.ok) {
                dot.className = 'status-dot online'; text.innerText = 'Online';
                btn.classList.remove('disabled');
            } else throw new Error();
        } catch (err) {
            dot.className = 'status-dot offline'; text.innerText = 'Offline';
            btn.classList.add('disabled');
        }
    }
    async function runChecks() {
        document.getElementById('lastCheckTime').innerText = 'Check: ' + new Date().toLocaleTimeString();
        const games = ['catchmind', 'KKUTU', 'Oh_Mock', 'Yacht_Dice', 'indian_poker', 'mahe', 'UNO', 'Clue'];
        // ê²½ë¡œëŠ” nginx.conf ì°¸ê³  (/catchmind/api/rooms ë“±) - ê° ê²Œì„ì— ì‹¤ì œ health checkìš© apiê°€ ìˆì–´ì•¼ ì •í™•í•¨.
        // í˜„ì¬ëŠ” ì„ì‹œë¡œ api/roomsë¥¼ ì°Œë¥´ë„ë¡ ë˜ì–´ ìˆìŒ.
        for(const g of games) {
            await checkStatus(g, `/${g}/api/rooms`);
        }
    }
</script>
</body>
</html>